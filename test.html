<!DOCTYPE html>
<html>
<head>
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<style> 
		
			body { text-align: center; }
		
</style>
</head>
<body>
<h1>Skylikes</h1>

<p id="status">hello</p>

<script src="js/goodreadsDataFetches.js"></script>
<script>

var svgWidth = 600
var svgHeight = 50


var svgContainer = d3.select("body") //create container
                     .append("svg")
                     .attr("width", svgWidth)
                     .attr("height",svgHeight)

svgContainer.append("rect")
            .attr("transform", "translate(" + svgWidth/2 + "," + svgHeight/2 + ")")
            .attr("x", -svgWidth/2)
            .attr("y", -svgHeight/2)
            .attr("width",svgWidth)
            .attr("height", svgHeight)
            .style("fill","white")
            .style("stroke-width",0.5)
            .style("stroke","#555555")
            
var progress = svgContainer.append("rect")
            .attr("transform", "translate(" + svgWidth/2 + "," + svgHeight/2 + ")")
            .attr("x", -svgWidth/2)
            .attr("y", -svgHeight/2)
            .attr("width",0)
            .attr("height", svgHeight)
            .style("fill","blue")
            //.style("stroke-width",0.5)
            //.style("stroke","#555555")

goodreadsDataFetches.statusUpdate = function(percentage,state){
	console.log("percentage " + percentage +" state "+ state)
	var newwidht = (percentage/100*svgWidth);
	progress.attr("width", newwidht);
	
	document.getElementById("status").innerHTML = "state: "+ state + " percentage: "+percentage +"%"
}

goodreadsDataFetches.finished = function(data){
	console.log("done")
	addXMLDownload("allData", data)
	document.getElementById("status").innerHTML = "done"

} 

var isUsingTestingDataset = getParameterByName("testingData") == "1"

if(isUsingTestingDataset){
	console.log("startWithTestingData")
	goodreadsDataFetches.startWithTestingData()
}else{
	console.log("start realData!")
	goodreadsDataFetches.start()
}

//http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function addXMLDownload(filename, data){
	window.URL = window.webkitURL || window.URL;

		var contentType = 'application/xml';

		var xmlFile = new Blob([data], {type: contentType});

		var a = document.createElement('a');
		a.download = filename+'.xml';
		a.href = window.URL.createObjectURL(xmlFile);
		a.textContent = 'Download '+filename+' XML';

		a.dataset.downloadurl = [contentType, a.download, a.href].join(':');
		
		document.body.appendChild(document.createElement('br'));
		document.body.appendChild(a);
}


</script>

</body>
</html>